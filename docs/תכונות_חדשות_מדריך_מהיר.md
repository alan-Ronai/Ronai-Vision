# מדריך מהיר - תכונות חדשות במערכת ראנאי

## סקירה כללית

ארבע תכונות עיקריות חדשות הוטמעו במערכת:

1. **מערכת הקלטה מבוססת אירועים**
2. **ניתוח מפורט באמצעות Gemini AI**
3. **מערכת דיבור סינתטי (TTS)**
4. **מערכת לוגים תפעוליים**

---

## 1. הקלטת וידאו אוטומטית

### יכולות
- הקלטה אוטומטית כשמזוהה אדם חמוש
- חיץ מעגלי ששומר 5 שניות לפני האירוע
- הקלטה ידנית דרך API
- עצירה אוטומטית כשהאדם החמוש יוצא מהמסגרת

### דוגמאות שימוש

#### התחלת הקלטה ידנית
```bash
curl -X POST http://localhost:8000/api/recorder/start \
  -H "Content-Type: application/json" \
  -d '{
    "camera_id": "camera_1",
    "trigger_reason": "בדיקה ידנית",
    "include_buffer": true
  }'
```

#### עצירת הקלטה
```bash
curl -X POST http://localhost:8000/api/recorder/stop/SESSION_ID
```

#### רשימת הקלטות פעילות
```bash
curl http://localhost:8000/api/recorder/sessions
```

### תיקיית פלט
הקלטות נשמרות ב: `output/recordings/`

פורמט שם קובץ: `camera_1_20250115_120000_armed_person_detected_track42.mp4`

---

## 2. ניתוח מפורט עם Gemini AI

### יכולות
- **רכבים**: זיהוי דגם, מספר רישוי, צבע
- **אנשים**: תיאור ביגוד, מאפיינים פיזיים, חפצים ביד
- **בעברית**: כל הפרומפטים והתשובות בעברית
- **חסכוני**: מקסימום 2-3 ניתוחים לכל ID

### הגדרת API Key
```bash
export GEMINI_API_KEY="your-api-key-here"
```

### דוגמאות תשובות

#### ניתוח רכב
```json
{
  "דגם": "טויוטה קורולה 2020",
  "מספר_רישוי": "12-345-67",
  "צבע": "כסוף מטאלי"
}
```

#### ניתוח אדם
```json
{
  "לבוש": "חולצת פולו כחולה וג'ינס כהה",
  "צבע_עור": "בהיר",
  "צבע_שיער": "חום כהה",
  "מין_משוער": "זכר",
  "גיל_משוער": "30-40",
  "פריטים_בידיים": ["תיק גב שחור", "בקבוק מים"],
  "תיאור_נוסף": "משקפיים שחורים, שעון יד, מנעלי ספורט לבנים"
}
```

### איך זה עובד?
1. מערכת מזהה רכב או אדם חדש
2. שולחת את התמונה ל-Gemini (עד פעמיים לכל ID)
3. מקבלת תיאור מפורט בעברית
4. שומרת במטאדאטה של המעקב
5. רושמת ללוג תפעולי

---

## 3. דיבור סינתטי (TTS)

### יכולות
- המרת טקסט לדיבור בעברית
- שמירת קבצי אודיו
- שידור לחיבורי RTP

### דוגמאות

#### יצירת קובץ אודיו
```bash
curl -X POST http://localhost:8000/api/audio/tts/synthesize \
  -H "Content-Type: application/json" \
  -d '{
    "text": "אדם חמוש זוהה במצלמה 1",
    "save_file": true
  }'
```

תגובה:
```json
{
  "success": true,
  "message": "Speech synthesized successfully",
  "audio_file": "output/tts/tts_1234567890.wav",
  "sample_rate": 16000,
  "duration": 2.5
}
```

#### שידור לחיבור RTP
```bash
curl -X POST "http://localhost:8000/api/audio/tts/speak-and-stream?text=שלום&session_id=session_123"
```

### דרישות מערכת
התקנת espeak:
```bash
# Linux
sudo apt-get install espeak espeak-data

# macOS
brew install espeak
```

### תיקיית פלט
קבצי אודיו נשמרים ב: `output/tts/`

---

## 4. לוגים תפעוליים

### מה זה?
לוגים ברמה גבוהה לאירועים חשובים, נפרדים מלוגים טכניים.

### סוגי אירועים
- **זיהוי** (detection): אובייקט חדש זוהה
- **התראה** (alert): אדם חמוש, הפרת אזור
- **ניתוח** (analysis): תוצאות ניתוח Gemini
- **הקלטה** (recording): התחלה/סיום הקלטה
- **מערכת** (system): הפעלה, כיבוי, שגיאות

### מיקום הלוג
`output/logs/operational.jsonl`

### פורמט
קובץ JSONL (JSON Lines) - שורה אחת לכל אירוע:

```json
{"timestamp": 1234567890.0, "event_type": "detection", "severity": "info", "camera_id": "camera_1", "track_id": 42, "message": "אובייקט חדש זוהה במצלמה camera_1: person (ID: 42)", "details": {}}
{"timestamp": 1234567891.0, "event_type": "alert", "severity": "critical", "camera_id": "camera_1", "track_id": 42, "message": "התראה במצלמה camera_1: אדם חמוש זוהה עם אקדח (ID: 42)", "details": {"weapons": ["pistol"]}}
{"timestamp": 1234567892.0, "event_type": "recording", "severity": "info", "camera_id": "camera_1", "track_id": 42, "message": "הקלטה החלה במצלמה camera_1, ID: 42 (סיבה: armed_person_detected)", "details": {}}
```

### צפייה בלוגים
```bash
# הצג את כל הלוגים
cat output/logs/operational.jsonl

# הצג רק התראות קריטיות
grep '"severity": "critical"' output/logs/operational.jsonl | jq .

# הצג התראות מצלמה ספציפית
grep '"camera_id": "camera_1"' output/logs/operational.jsonl | jq .

# הצג אירועים מהשעה האחרונה
grep '"timestamp":' output/logs/operational.jsonl | \
  awk -v t=$(date -d '1 hour ago' +%s) '$0 ~ /"timestamp": [0-9.]+/ && $2 > t' | jq .
```

### פלט מסך
הלוגים מוצגים גם במסך עם צבעים:

```
[INFO] [2025-01-15 12:00:00] [DETECTION] [camera_1] [Track:42] אובייקט חדש זוהה במצלמה camera_1: person (ID: 42)
[CRITICAL] [2025-01-15 12:00:01] [ALERT] [camera_1] [Track:42] התראה במצלמה camera_1: אדם חמוש זוהה עם אקדח (ID: 42)
[INFO] [2025-01-15 12:00:02] [RECORDING] [camera_1] [Track:42] הקלטה החלה במצלמה camera_1, ID: 42
```

צבעים:
- **INFO**: לבן (מידע רגיל)
- **WARNING**: צהוב (אזהרה)
- **CRITICAL**: אדום (קריטי)

---

## תרחיש שימוש מלא

### 1. הגדרה ראשונית

```bash
# הגדר Gemini API key
export GEMINI_API_KEY="your-api-key"

# התקן espeak לTTS
sudo apt-get install espeak espeak-data  # Linux
# או
brew install espeak  # macOS

# צור תיקיות פלט
mkdir -p output/recordings output/tts output/logs
```

### 2. הפעלת המערכת

```bash
# הפעל את השרת
START_RUNNER=true PARALLEL=true python -m scripts.run_multi_camera
```

### 3. תרחיש: אדם חמוש מזוהה

```
[12:00:00] אדם נכנס לשדה הראיה של camera_1
    ↓
[12:00:01] מערכת: זיהוי אדם חדש (Track ID: 42)
    ↓ לוג: "אובייקט חדש זוהה במצלמה camera_1: person (ID: 42)"
    ↓
[12:00:02] Gemini: ניתוח מתבצע (ניסיון 1/2)
    ↓ תוצאה: "גבר, גיל 30-40, חולצה שחורה, ג'ינס, תיק גב"
    ↓ לוג: "זוהה אדם במצלמה camera_1 (ID: 42): חולצה שחורה, ג'ינס..."
    ↓
[12:00:03] מזוהה נשק (אקדח) ליד האדם
    ↓ אדם מתויג כ"armed"
    ↓ לוג: "התראה במצלמה camera_1: אדם חמוש זוהה עם אקדח (ID: 42)"
    ↓
[12:00:04] הקלטה מתחילה אוטומטית
    ↓ כולל 5 שניות קודמות מהחיץ
    ↓ לוג: "הקלטה החלה במצלמה camera_1, ID: 42 (סיבה: armed_person_detected)"
    ↓ קובץ: output/recordings/camera_1_20250115_120004_armed_person_detected_track42.mp4
    ↓
[12:00:05] (אופציונלי) TTS מכריז
    ↓ "אדם חמוש זוהה במצלמה 1"
    ↓ שידור ל-RTP או שמירת קובץ
    ↓
[12:00:30] אדם יוצא מהמסגרת
    ↓ מערכת מזהה שהאדם החמוש לא נמצא יותר
    ↓ עצירת הקלטה אוטומטית
    ↓ לוג: "הקלטה הסתיימה במצלמה camera_1, שמור ב: ..."
```

### 4. בדיקת תוצאות

```bash
# צפה בהקלטה
ls -lh output/recordings/
vlc output/recordings/camera_1_20250115_120004_armed_person_detected_track42.mp4

# בדוק לוגים
tail -f output/logs/operational.jsonl | jq .

# בדוק מטאדאטה (כולל ניתוח Gemini)
curl http://localhost:8000/api/metadata/tracks/42 | jq .
```

---

## API - סיכום מהיר

### הקלטה
```
POST   /api/recorder/start          - התחל הקלטה
POST   /api/recorder/stop/{id}      - עצור הקלטה
GET    /api/recorder/sessions       - רשימת הקלטות פעילות
```

### TTS
```
POST   /api/audio/tts/synthesize         - המר טקסט לדיבור
POST   /api/audio/tts/speak-and-stream   - המר ושדר ל-RTP
GET    /api/audio/tts/status             - סטטוס מנוע TTS
```

### מטאדאטה (כולל Gemini)
```
GET    /api/metadata/tracks/{id}    - קבל מטאדאטה של מעקב
GET    /api/metadata/search         - חפש לפי תגיות/התראות
```

---

## פתרון בעיות נפוצות

### הקלטה לא מתחילה
✓ בדוק שהמצלמה פעילה
✓ בדוק שיש מקום בדיסק
✓ בדוק הרשאות כתיבה ל-output/recordings

### Gemini לא עובד
✓ ודא ש-GEMINI_API_KEY מוגדר
✓ בדוק חיבור לאינטרנט
✓ ודא מכסת API לא מלאה

### TTS לא עובד
✓ התקן espeak: `sudo apt-get install espeak`
✓ בדוק התקנת pyttsx3: `pip install pyttsx3`

### לוגים לא נראים
✓ בדוק קידוד UTF-8 בטרמינל
✓ הגדר: `export LANG=he_IL.UTF-8`

---

## ביצועים

### זיכרון
- חיץ הקלטה: ~150MB לכל מצלמה (150 פריימים)
- Gemini: זניח (רק HTTP requests)
- TTS: ~50MB (מנוע espeak)

### רשת
- Gemini: ~1-2 MB לכל ניתוח
- TTS streaming: תלוי באורך הטקסט

### דיסק
- הקלטות: ~5-10 MB לשנייה (תלוי ברזולוציה וקודק)
- לוגים: ~1 KB לכל אירוע
- TTS: ~100 KB לשנייה אודיו

---

## תכונות עתידיות מתוכננות

- [ ] הקלטת H.264 מואצת חומרה
- [ ] העלאת הקלטות לענן (S3/Azure)
- [ ] ניתוח Gemini אסינכרוני (תור)
- [ ] TTS עצבי (איכות טובה יותר)
- [ ] ממשק גרפי ללוגים תפעוליים
- [ ] התראות בזמן אמת (WebSocket)

---

## תמיכה

לשאלות או בעיות, פנה למפתחי המערכת או עיין בתיעוד המלא.
